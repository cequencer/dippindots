#!/bin/bash
# Note: run `xrandr -q` to list connected outputs (monitors). Set the appropriate monitor as EXMON.

PLACE=$1
INMON=eDP1
EXMON=HDMI1

function restart_panel {
    # Kill the panel/lemonbar and restart
    pkill panel
    panel &
}

# get monitor EDIDs
function edids {
    PATTERN="EDID:.\{256\}"
    # if specified, get a single edid
    if [ $1 ]; then
        PATTERN="$1.\+$PATTERN"
    fi
    xrandr -q --props | tr '\n' ' ' | tr -d '\t' | tr -d ' ' | grep -o $PATTERN |  cut -d':' -f2
}

function count_mons {
    edids | wc -l
}


if [[ $PLACE == 'mon' ]]; then
    N_MONS=$(count_mons)
    while true; do
        if [ -f "/tmp/lock" ]; then
            continue
        fi
        NEW_N_MONS=$(count_mons)
        if [ "$NEW_N_MONS" -gt "$N_MONS" ]; then
            EXT_EDID=$(edids "HDMI1")
            EXT_POS=$(cat ~/.mons | grep $EXT_EDID | cut -d' ' -f2)
            # if the preferred position is specified,
            # do it automatically
            if [ -n "$EXT_POS" ]; then
                multihead $EXT_POS
            fi

        elif [ "$NEW_N_MONS" -lt "$N_MONS" ]; then
            # disconnected
            multihead reset
        fi
        N_MONS=$NEW_N_MONS
        sleep 1
    done
else
    # so bspc properly picks up the primary monitor
    xrandr --output $INMON --auto --primary

    # Set this here for convenience
    bspc config remove_unplugged_monitors true

    if [[ $PLACE == 'right' ]]; then
        EXMON_PLACE=R
        INMON_PLACE=L
        POSITION=right-of
    elif [[ $PLACE == 'left' ]]; then
        EXMON_PLACE=L
        INMON_PLACE=R
        POSITION=left-of
    elif [[ $PLACE == 'above' ]]; then
        EXMON_PLACE=A
        INMON_PLACE=B
        POSITION=above
    elif [[ $PLACE == 'below' ]]; then
        EXMON_PLACE=B
        INMON_PLACE=A
        POSITION=below
    elif [[ $PLACE == 'reset' ]]; then
        # figure out the primary monitor name
        PRNAME=$(bspc query -M -m primary --names)
        if [[ $PRNAME == 'R' ]]; then
            EXNAME=L
        elif [[ $PRNAME == 'L' ]]; then
            EXNAME=R
        elif [[ $PRNAME == 'A' ]]; then
            EXNAME=B
        elif [[ $PRNAME == 'B' ]]; then
            EXNAME=A
        fi

        if [ ! -z "$EXNAME" ]; then
            # TODO how to get non-primary monitor name?
            # try getting primary mon id, then getting the next monitor

            # list windows on ext mon, move them to primary mon
            bspc query -N -m $EXNAME | xargs -L1 -I % bspc node % -m primary

            # list desktops on ext mon, get their numbers, remove them all
            bspc query -D -m $EXNAME | grep -n '.' | cut -f1 -d: | xargs -L1 -I % bspc desktop $EXNAME:^% -r

            # rename the monitors for reuse later
            bspc monitor primary -n $INMON
            bspc monitor $EXNAME -n $EXMON

            # "unplug" the monitor
            xrandr --output $EXMON --off

            # the last desktop sticks, so remove it
            bspc desktop primary:^$(bspc query -D | wc -l) -r

            # reset the wallpaper to render properly
            feh --bg-fill ~/.wall.jpg &
        fi

        restart_panel
        exit 0
    else
        echo "Please specify 'left', 'right', 'above', 'below', or 'reset'."
        exit 1
    fi

    # set primary monitory
    xrandr --output $INMON --auto --primary
    bspc monitor primary -n $INMON

    # place the external monitor to the specified position
    xrandr --output $EXMON --auto --$POSITION $INMON

    # NOTE some monitors will be set to "overscan"
    # which clips the borders.
    # you can try something like this to compensate:
    # xrandr --output HDMI-1 --set underscan on
    # xrandr --output HDMI-1 --set "underscan hborder" 40 --set "underscan vborder" 25

    # rename each monitor so sxhkd can use it with bspwm to move focus/windows/desktops across monitors
    bspc monitor $(bspc query -M -m primary --names) -n $INMON_PLACE
    bspc monitor $(bspc query -M -m primary#next --names) -n $EXMON_PLACE

    # setup desktops on external monitor
    bspc monitor $EXMON_PLACE -d   

    # reset the wallpaper to render properly
    feh --bg-fill ~/.wall.jpg &

    restart_panel
fi