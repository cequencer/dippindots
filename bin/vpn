#!/bin/bash
# for this to work w/o entering a sudo password,
# add the following after running `sudo visudo`
#   ftseng  ALL = NOPASSWD: /usr/bin/pkill
#   ftseng  ALL = NOPASSWD: /usr/sbin/openvpn
#   ftseng  ALL = NOPASSWD: /usr/sbin/service stunnel4


if [[ $1 == 'up' ]]; then
    # kill all existing stunnel4 processes to avoid this error:
    # Error binding service [openvpn] to 127.0.0.1:1413
    # bind: Address already in use (98)
    # sudo killall stunnel4

    # to set active vpn server, symlink its folder, i.e.:
    # ln -s ~/docs/vpn/<server name> ~/ftseng/docs/vpn/active
    cd /home/ftseng/docs/vpn/active

    sudo service stunnel4 restart
    stunnel4 airvpn.ssl # make sure this does not have `foreground = yes` in it
    sudo openvpn --config airvpn-ssl.ovpn --daemon
    echo "VPN active"
elif [[ $1 == 'down' ]]; then
    sudo service stunnel4 stop
    sudo pkill openvpn
    sudo pkill stunnel4
    echo "VPN deactivated"
else
    echo "Please specify 'up' or 'down'."
    exit 0
fi