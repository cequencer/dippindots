#!/usr/bin/python2

import os
import gtk
import json
import subprocess

here = os.path.dirname(os.path.realpath(__file__))
emoji = json.load(open(os.path.join(here, '_emoji/emoji.json'), 'r'))

def refocus():
    subprocess.Popen(['bspc', 'window', '-f', 'last']).wait()

def paste(code):
    clipboard = gtk.Clipboard()
    clipboard.set_text(code)
    refocus()
    subprocess.Popen(['xdotool', 'key', '--clearmodifiers', 'ctrl+v']).wait()

def search(q):
    results = []
    for data in emoji.values():
        name = data['name']
        kws = data['keywords']
        code = data['unicode']
        shortname = data['shortname']
        aliases = data['aliases']

        # for simplicity of searching,
        # ignore skin tone codes
        if '-' in code:
            continue

        if q in name\
            or any(q in kw for kw in kws)\
            or any(q in a for a in aliases)\
            or q in shortname:
            results.append((name, unichr(int(code, 16))))
    return results

def select(results):
    selected = None
    for i, (name, _) in enumerate(results):
        print('[{}] {}'.format(i, name))
    while selected is None:
        inp = raw_input('Select #: ')
        try:
            selected = results[int(inp)]
        except (IndexError, ValueError):
            pass
    return selected[1]

if __name__ == '__main__':
    print('Search for an emoji:')

    try:
        while True:
            q = raw_input('> ')
            results = search(q)
            if not results:
                print('No results')
            elif len(results) == 1:
                name, code = results[0]
                paste(code)
                refocus()
            else:
                print('Multiple results:')
                code = select(results)
                paste(code)
                refocus()
    except (KeyboardInterrupt, EOFError):
        print('')
        exit(0)